# 天気情報取得ツールの追加

---

## 概要
エージェントが指定された地域の現在の天気と天気予報を取得できるようにする

### 目的
- エージェントが天気情報を取得し、ユーザーに天気に応じた適切なアドバイスを提供できるようにしたい

### 背景
- とあるエリアのイベント情報を検索できるコンシェルジュエージェントAIを開発中
- ユーザーに対して「今日の東京の天気は雨なので、屋内イベントがおすすめです！」のような天気を考慮したアドバイスを提供したい
- 現状、エージェントは天気情報を取得する手段がない

### 要件
- 既存のツールアーキテクチャに習ってツールを追加する
- 1週間分の天気予報を取得できるようにする（今日から7日後まで）
- 地域指定は都市名で行えるようにする
- エージェントが天気情報を理解し、ユーザーに適切なアドバイスを提供できるようなデータを返す
- 「明後日」「週末」などの質問にも対応できるようにする

---

## 詳細仕様

### 修正・追加対象ファイル

#### 新規作成
1. **`src/core/tools/weather_tool.py`**
   - 天気情報取得ツールの実装
   - BaseToolを継承したWeatherToolクラス

#### 修正
2. **`src/core/tools/registry.py`**
   - WeatherToolをLangChainツールとして登録するロジックを追加

3. **`src/core/tools/__init__.py`**
   - WeatherToolをインポートし、tool_registryに登録

4. **`tests/unit/core/tools/test_weather_tool.py`** (新規作成)
   - WeatherToolのユニットテスト

---

### 処理の流れ

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Agent as エージェント
    participant WeatherTool as WeatherTool
    participant JMA as 気象庁API

    User->>Agent: 「明後日の東京の天気は？」
    Agent->>WeatherTool: get_weather(location="東京")
    WeatherTool->>WeatherTool: 都市名→地域コード変換
    WeatherTool->>JMA: 天気予報APIリクエスト
    JMA->>WeatherTool: JSON形式の天気データ（1週間分）
    WeatherTool->>WeatherTool: データ解析・整形
    WeatherTool->>Agent: 構造化された天気情報（7日分）
    Agent->>User: 「明後日の東京は晴れだよ！屋外イベントがおすすめ！」
```

---

### 実装詳細

#### 1. WeatherToolクラスの実装内容

**基本構造:**
- BaseToolを継承
- ツール名: `get_weather`
- 非同期実行には対応しない（同期処理のみ）

**主要メソッド:**

1. **`name`プロパティ**
   - 返り値: `"get_weather"`

2. **`description`プロパティ**
   - ツールの使用方法、対応地域、返り値の説明を含む
   - エージェントが理解しやすい日本語で記述
   - 「今日から7日後までの天気予報を取得できる」ことを明記

3. **`execute(location: str) -> dict`**
   - 引数: `location` (都市名、例: "東京", "大阪")
   - 処理内容:
     1. 都市名を気象庁の地域コードに変換
     2. 気象庁APIにHTTPリクエストを送信
     3. レスポンスをJSON解析
     4. 1週間分（最大7日分）の天気予報を抽出・整形
     5. 構造化されたデータを返す
   - 返り値: 天気情報の辞書（詳細は後述）

4. **`_get_area_code(location: str) -> str`** (内部メソッド)
   - 都市名から気象庁の地域コードを取得
   - 主要都市のマッピング辞書を使用
   - 対応都市例: 東京、大阪、名古屋、福岡、札幌、仙台など

5. **`_fetch_weather_data(area_code: str) -> dict`** (内部メソッド)
   - 気象庁APIにリクエストを送信してJSONデータを取得
   - 使用API: `https://www.jma.go.jp/bosai/forecast/data/forecast/{area_code}.json`
   - タイムアウト: 10秒
   - エラーハンドリング: 接続エラー、タイムアウト、JSONパースエラー

6. **`_parse_weather_info(data: dict) -> dict`** (内部メソッド)
   - APIレスポンスから必要な情報を抽出
   - 1週間分の天気予報を取得（最大7日分）
   - データ構造を整形

**返り値のデータ構造:**
```json
{
  "location": "東京",
  "area_code": "130000",
  "forecast": [
    {
      "date": "2025-10-21",
      "weather": "雨",
      "temperature": {
        "min": "18",
        "max": "22"
      }
    },
    {
      "date": "2025-10-22",
      "weather": "曇り",
      "temperature": {
        "min": "17",
        "max": "23"
      }
    },
    {
      "date": "2025-10-23",
      "weather": "晴れ",
      "temperature": {
        "min": "16",
        "max": "25"
      }
    }
    // ... 最大7日分
  ],
  "publishing_office": "気象庁",
  "report_datetime": "2025-10-21T11:00:00+09:00"
}
```

エラー時の返り値:
```json
{
  "error": "エラーメッセージ"
}
```

**エラーハンドリング:**
- 未対応の都市名の場合: `{"error": "指定された地域はサポートされていません: {location}"}`
- API接続エラー: `{"error": "天気情報の取得に失敗しました: {エラー詳細}"}`
- データ解析エラー: `{"error": "天気データの解析に失敗しました"}`

**対応地域リスト（初期実装）:**
| 都市名 | 地域コード |
|--------|-----------|
| 東京   | 130000    |
| 大阪   | 270000    |
| 名古屋 | 230000    |
| 福岡   | 400000    |
| 札幌   | 016000    |
| 仙台   | 040000    |
| 広島   | 340000    |
| 神戸   | 280000    |

---

#### 2. ToolRegistryの修正内容

**修正箇所:** `src/core/tools/registry.py`の`_create_langchain_tool`メソッド

**追加内容:**
- `tool_name == "get_weather"`の条件分岐を追加
- LangChainの`@tool`デコレータを使用してツールを定義
- 型注釈付きの関数を作成:
  ```python
  @tool
  def get_weather(location: str) -> dict:
      """指定された地域の1週間分の天気予報を取得します。

      Args:
          location: 都市名（例: 東京、大阪）

      Returns:
          天気情報の辞書（最大7日分の天気、気温）
      """
      return tool_instance.execute(location=location)
  ```

---

#### 3. ツール登録の修正内容

**修正箇所:** `src/core/tools/__init__.py`

**追加内容:**
```python
from src.core.tools.weather_tool import WeatherTool

# WeatherToolの登録
tool_registry.register_tool(WeatherTool())
```

---

### 実装手順とテスト方法

#### ステップ1: WeatherToolクラスの基本実装

**実装内容:**
- `src/core/tools/weather_tool.py`を作成
- BaseToolを継承したWeatherToolクラスを実装
- `name`と`description`プロパティを実装
- 基本的な`execute`メソッドの骨組みを作成（まだAPIは呼ばない）

**確認方法:**
```bash
PYTHONPATH=. python -c "from src.core.tools.weather_tool import WeatherTool; tool = WeatherTool(); print(tool.name); print(tool.description)"
```

**期待結果:**
- ツール名 "get_weather" が表示される
- 説明文が表示される
- エラーなくインポートできる

---

#### ステップ2: 地域コード変換機能の実装

**実装内容:**
- `_get_area_code`メソッドを実装
- 主要都市のマッピング辞書を作成
- 未対応都市のエラーハンドリング

**確認方法:**
```bash
PYTHONPATH=. python -c "
from src.core.tools.weather_tool import WeatherTool
tool = WeatherTool()
print('東京:', tool._get_area_code('東京'))
print('大阪:', tool._get_area_code('大阪'))
try:
    tool._get_area_code('未対応都市')
except ValueError as e:
    print('エラー検出OK:', e)
"
```

**期待結果:**
- 東京 → 130000
- 大阪 → 270000
- 未対応都市 → ValueErrorが発生

---

#### ステップ3: 気象庁APIとの通信実装

**実装内容:**
- `_fetch_weather_data`メソッドを実装
- `requests`ライブラリを使用してHTTPリクエスト
- タイムアウト設定（10秒）
- エラーハンドリング（接続エラー、タイムアウト）

**確認方法:**
```bash
PYTHONPATH=. python -c "
from src.core.tools.weather_tool import WeatherTool
tool = WeatherTool()
data = tool._fetch_weather_data('130000')  # 東京
print('データ取得成功:', type(data), len(str(data)))
"
```

**期待結果:**
- JSONデータが取得できる（辞書型）
- エラーなく実行完了

---

#### ステップ4: データ解析・整形機能の実装（1週間分）

**実装内容:**
- `_parse_weather_info`メソッドを実装
- APIレスポンスから1週間分（最大7日分）の天気を抽出
- 各日の気温（最低・最高）を抽出
- 仕様で定義したJSON構造に整形（forecastリスト形式）

**確認方法:**
```bash
PYTHONPATH=. python -c "
from src.core.tools.weather_tool import WeatherTool
import json
tool = WeatherTool()
result = tool.execute(location='東京')
print(json.dumps(result, ensure_ascii=False, indent=2))
print('予報日数:', len(result.get('forecast', [])))
"
```

**期待結果:**
```json
{
  "location": "東京",
  "area_code": "130000",
  "forecast": [
    {
      "date": "2025-10-21",
      "weather": "晴れ",
      "temperature": {
        "min": "18",
        "max": "25"
      }
    },
    // ... 7日分
  ],
  ...
}
```
- 予報日数が最大7日分表示される

---

#### ステップ5: ToolRegistryへの登録

**実装内容:**
- `src/core/tools/registry.py`に`get_weather`の登録ロジックを追加
- `src/core/tools/__init__.py`でWeatherToolを登録

**確認方法:**
```bash
PYTHONPATH=. python -c "
from src.core.tools import tool_registry
tools = tool_registry.get_tool_descriptions()
weather_tool = [t for t in tools if t['name'] == 'get_weather']
print('登録確認:', weather_tool)
"
```

**期待結果:**
- `get_weather`ツールがツールリストに含まれている

---

#### ステップ6: エージェントとの統合テスト

**実装内容:**
- Streamlitアプリを起動
- エージェントに天気に関する質問をする（特に「明後日」「週末」などの質問）

**確認方法:**
```bash
make run
# ブラウザでアクセス後、以下のメッセージを送信:
# 「東京の天気を教えて」
# 「明日の大阪の天気は？」
# 「明後日は晴れる？」
# 「週末の天気はどう？」
```

**期待結果:**
- エージェントが`get_weather`ツールを使用
- 1週間分の天気情報を取得して回答
- 「明後日は晴れなので屋外イベントがおすすめ！」のような提案が表示される
- 「週末は雨だから屋内イベントがいいかも」のような提案が表示される

---

#### ステップ7: ユニットテストの作成

**実装内容:**
- `tests/unit/core/tools/test_weather_tool.py`を作成
- 以下のテストケースを実装:
  1. ツール名・説明のテスト
  2. 地域コード変換のテスト
  3. APIデータ取得のテスト（モック使用）
  4. データ解析のテスト（7日分のデータが正しく解析されるか）
  5. エラーハンドリングのテスト

**確認方法:**
```bash
PYTHONPATH=. pytest tests/unit/core/tools/test_weather_tool.py -v
```

**期待結果:**
- すべてのテストがPASS
- カバレッジ80%以上

---

### 最終的な達成要件

以下のすべてが満たされた状態を完了とする:

1. **機能要件:**
   - [ ] WeatherToolが正常に動作し、指定された都市の天気情報を取得できる
   - [ ] 1週間分（最大7日分）の天気予報（天気状態、最低気温、最高気温）が取得できる
   - [ ] 主要8都市（東京、大阪、名古屋、福岡、札幌、仙台、広島、神戸）に対応
   - [ ] エラーハンドリングが適切に機能する（未対応都市、API接続エラー）

2. **統合要件:**
   - [ ] ToolRegistryに正しく登録されている
   - [ ] エージェントから`get_weather`ツールが利用可能
   - [ ] エージェントが天気情報を元に適切なアドバイスを提供できる
   - [ ] 「明後日」「週末」などの質問にも対応できる

3. **品質要件:**
   - [ ] ユニットテストがすべてPASS
   - [ ] 型チェック（mypy）がエラーなく通る
   - [ ] コードフォーマット（Black, isort, Ruff）が適用されている
   - [ ] ログ出力が適切に実装されている

4. **ドキュメント要件:**
   - [ ] descriptionプロパティに使用方法が明記されている
   - [ ] 対応地域リストが記載されている
   - [ ] 1週間分の予報が取得できることが明記されている
   - [ ] エラーメッセージが分かりやすい

5. **動作確認:**
   - [ ] Streamlitアプリ上でエージェントに「東京の天気は？」と質問して正しく応答する
   - [ ] 「明後日の天気は？」と質問して正しく応答する
   - [ ] 「今日は雨なので屋内イベントがおすすめ」のような天気に応じた提案が行われる
   - [ ] 「週末は晴れなので屋外イベントがいいね！」のような提案が行われる
