# パーソナライゼーション機能実装確認手順書

## 🎯 確認項目チェックリスト

### ✅ **Phase 1: 基本機能確認**

#### 1.1 ツール登録確認
```bash
# 実行コマンド
.venv\Scripts\python.exe verify_implementation.py

# 期待結果
✅ 登録ツール数: 7
✅ ユーザー分析ツールが正常に登録されています
```

#### 1.2 ユーザー分析ツール動作確認
```bash
# 期待結果
✅ ユーザー分析成功
   主な興味: {'category_飲食': X, 'time_夜': Y}
   行動パターン: {'companion_友人': Z}
   分析サマリー: 主な興味: 飲食, 夜の時間帯 | 行動パターン: 友人での来訪
```

### ✅ **Phase 2: パーソナライゼーション確認**

#### 2.1 プロンプト生成確認
```bash
# 期待結果
✅ 通常プロンプト長: 1524文字
✅ パーソナライズプロンプト長: 1600-1700文字
✅ ユーザープロファイル情報が正常に組み込まれています
```

#### 2.2 複数シナリオテスト
```bash
# 期待結果
✅ エンタメ好き: 主な興味: エンターテイメント
✅ ファミリー層: 主な興味: 家族・子供, 飲食 | 行動パターン: 家族での来訪
✅ ビジネス利用: 主な興味: ビジネス
```

### ✅ **Phase 3: 実データ統合確認**

#### 3.1 時刻・イベントデータ取得
```bash
# 期待結果
✅ 現在時刻: 2025-10-03 XX:XX:XX
✅ 取得イベント数: 1以上
   例: 『任せ方がわかりません』出版記念イベント (2025-10-17)
```

### ✅ **Phase 4: 統合機能テスト**

#### 4.1 Streamlitアプリ起動テスト
```bash
.venv\Scripts\python.exe -m streamlit run src/app.py

# 期待結果
- ブラウザで http://localhost:8501 が開く
- 7つのツールが表示される
- チャット機能が利用可能
```

#### 4.2 エンドツーエンドテスト手順

**Step 1**: Streamlitアプリにアクセス
**Step 2**: 以下の順序でメッセージを送信

1. 「レストラン情報を教えて」
2. 「友人とディナーを楽しみたい」
3. 「夜の時間帯で営業している店舗は？」

**Step 3**: 期待される動作
- ユーザー分析ツールが自動実行される
- 「飲食」「夜の時間帯」「友人での来訪」が検出される
- パーソナライズされた回答が提供される

## 🔍 **トラブルシューティング**

### 問題1: ツール登録数が7未満
**原因**: インポートエラーまたは依存関係の問題
**対策**:
```bash
.venv\Scripts\python.exe -c "from src.core.tools import tool_registry; print(tool_registry.get_all_tool_instances().keys())"
```

### 問題2: ユーザー分析が失敗
**原因**: チャット履歴の形式問題
**対策**:
```bash
# 正しい形式確認
[{"role": "user", "content": "メッセージ内容"}]
```

### 問題3: プロンプトにユーザー情報が含まれない
**原因**: 分析結果の形式問題
**対策**:
```bash
# analysis_summary キーの存在確認
.venv\Scripts\python.exe -c "
result = user_analysis_tool.execute(chat_history=test_data)
print('analysis_summary' in result.get('analysis', {}))
"
```

### 問題4: Streamlitアプリが起動しない
**原因**: 依存関係またはポートの問題
**対策**:
```bash
# 依存関係確認
.venv\Scripts\python.exe -m pip list | findstr streamlit

# ポート変更
.venv\Scripts\python.exe -m streamlit run src/app.py --server.port 8502
```

## 📊 **性能確認指標**

### 応答時間目標
- ユーザー分析実行: < 0.1秒
- プロンプト生成: < 0.05秒
- データ検索: < 0.5秒

### メモリ使用量
- セッション内分析データ: < 1MB
- プロンプト生成: < 10KB

## 🎉 **実装完了の判定基準**

✅ すべてのPhase 1-4のテストがパス
✅ 3つ以上の異なるユーザーシナリオで適切な分析結果
✅ パーソナライズプロンプトが正常生成
✅ 実データ取得・活用が動作
✅ Streamlitアプリでエンドツーエンドテストが成功

**判定**: 上記すべてが✅の場合、実装完了と判定
